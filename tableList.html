<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>代码生成器</title>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="./src/lib/element-ui/2.13.0/theme-chalk/index.css">
  <link rel="stylesheet" href="./src/lib/tt/tableTemplate.css">
  <style>
    [v-cloak] {
      display: none;
    }
  </style>
</head>
<body>
<div id="app" v-cloak>
  <table-template
    :data="tableList"
    :config="config"
    :table-loading="tableLoading"
    @submit-search="handleSearch"
    @page-change="getTableList"
    :page='params'>
  </table-template>
  <el-dialog title="配置" :visible.sync="dialogVisible" :close-on-click-modal="false">
    <table-template
      :data="columnList"
      :config="columnConfig">
      <template v-slot:columnname="row">
        <div>{{row}}</div>
      </template>
    </table-template>
    <div slot="footer">
      <el-button @click="dialogVisible=false">取 消</el-button>
      <el-button type="primary" :loading="handleLoading" @click="handleSubmit">生成代码</el-button>
    </div>
  </el-dialog>
</div>
<script src="./src/lib/vue.js"></script>
<script src="./src/lib/element-ui/2.13.0/index.js"></script>
<script src="./src/lib/tt/tableTemplate.umd.min.js"></script>
<script>
  const util = require("./src/utils/util");
  const dbUtil = require("./src/db/connect");
  new Vue({
    el: "#app",
    data() {
      return {
        tableList: [],
        columnList: [],
        tableLoading: false,
        dialogVisible: false,
        handleLoading: false,
        curRow: {},
        config: {
          withoutDialog: true,
          handlerProps: {width: "80px"},
          showAddBtn: false,
          showIndex: true,
          columns: [
            {
              label: '表名',
              field: 'tableName',
            },
            {
              label: '创建时间',
              field: 'createTime',
              hideInSearch: true,
              render: row => {
                return util.formatTime(row.createTime, "yyyy-MM-dd hh:mm:ss");
              }
            }
          ],
          handlerList: [
            {
              label: '配置',
              icon: 'el-icon-edit',
              click: row => {
                this.getColumnList({tableName: row.tableName});
                this.dialogVisible = true;
              }
            },
          ],
        },
        columnConfig: {
          withoutDialog: true,
          searchable: false,
          showAddBtn: false,
          pageable: false,
          columns: [
            {
              label: '字段',
              field: 'columnName',
            },
            {
              label: '类型',
              field: 'dataType',
            },
            {
              label: '显示名称',
              field: 'label',
              type: 'input'
            },
            {
              label: '表格中显示',
              field: 'hideInTable',
              type: 'checkbox'
            },
          ],
        },
        params: {
          current: 1,
          size: 10,
          total: 10
        }
      }
    },
    methods: {
      getTableList() {
        this.tableLoading = true;
        dbUtil.getTableList(this.params).then(results => {
          this.tableList = results;
          this.tableLoading = false;
        }).catch(err => {
          this.$message.error(err.sqlMessage);
          this.tableLoading = false;
        });
        this.countTable();
      },
      getColumnList(params) {
        this.handleLoading = true;
        dbUtil.getColumnList(params).then(results => {
          console.log(results)
          results.forEach(v => {
            v.label = v.columnComment;
            v.hideInTable = false;
          });
          this.columnList = results;
          this.handleLoading = false;
        }).catch(err => {
          this.$message.error(err.sqlMessage);
          this.handleLoading = false;
        });
      },
      countTable() {
        dbUtil.countTable(this.params).then(total => {
          this.params.total = total;
        }).catch(err => this.$message.error(err.sqlMessage));
      }
      ,
      handleSearch(params) {
        this.params.current = 1;
        this.params = {...this.params, ...params};
        this.getTableList();
      }
      ,
      handleSubmit() {

      }
    }
    ,
    mounted() {
      this.getTableList();
    }
  });
</script>
</body>
</html>
